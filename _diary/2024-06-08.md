#redis #system-design

### First-come, first-served

* [UserQueueService.java](https://github.com/morenice/fastcampus-2023-backend-advacned/blob/main/ch4/clip08/flow/src/main/java/com/fastcampus/flow/service/UserQueueService.java)

#### Sequence Diagram

##### V1

```plantuml
@startuml

participant Client
participant "Controller<Serivce>" as ServiceController
participant "Controller<Wait>" as Controller
participant Service
queue Redis

Client -> ServiceController: GET /service.html
  ServiceController -> ServiceController: retrieve allow_token (Cookie)
  ServiceController -> Controller: GET /api/allowed?user_id&allow_token
  ServiceController <-- Controller: not allowed
Client <-- ServiceController: 302 Found\nLocation: /waiting.html

Client -> Controller: GET /waiting.html
  Controller -> Service: enqueue(queue:wait, user_id)
    Service -> Redis: ZADD queue:wait timestamp user_id
    Service <-- Redis: OK
  Controller <-- Service: rank (in queue:wait)
Client <-- Controller: rank

group waiting
  Client -> Controller: GET /api/rank?user_id
  Controller -> Service: rank(queue:wait, user_id)
  Controller <-- Service: rank
  Client <-- Controller: rank
end

group @Schedule
  Service -> Service: allow(queue:wait, count)
  Service -> Redis: ZPOPMIN wait:queue count
  Service <-- Redis: [user_id, ...]
  loop
    Service -> Redis: ZADD proceed:queue timestamp user-id
    Service <-- Redis: OK
  end
end

group proceed
  Client -> Controller: GET /api/rank?user_id=
  Client <-- Controller: rank of user
  Client -> Client: redirect /service.html
  Client -> ServiceController: GET /service.html
  Client <-- ServiceController
end

@enduml
```

```
Controller -> Service: generateToken(wait:queue, user-id)
Controller <-- Service: allow-token
Client <-- Controller: rank of user + Cookie(allow-token)
```
