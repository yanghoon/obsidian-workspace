#redis #system-design

### First-come, first-served

* [UserQueueService.java](https://github.com/morenice/fastcampus-2023-backend-advacned/blob/main/ch4/clip08/flow/src/main/java/com/fastcampus/flow/service/UserQueueService.java)

```plantuml
@startuml

participant Client
participant "Controller<Wait>" as Controller
participant "Controller<Serivce>" as ServiceController
participant Service
queue Redis

Client -> ServiceController: GET /service.html
ServiceController -> Controller: GET /api/allowd?user_id&atoken

Client -> Controller: GET /waiting.html
Controller -> Service: enqueue(wait:queue, user-id)
Service -> Redis: ZADD NX wait:queue timestamp user-id
Service <-- Redis: OK
Controller <-- Service: rank of user (in wait:queue)
Client <-- Controller

group wait
Client -> Controller: GET /api/rank?user_id=
Controller -> Service: rank(wait:queue, user-id)
Controller <-- Service: rank of user
Client <-- Controller
end

group @Schedule
  Service -> Service: allow(wait:queue, count)
  Service -> Redis: ZPOPMIN wait:queue count
  Service <-- Redis: [user-id, ...]
  loop
    Service -> Redis: ZADD NX proceed:queue timestamp user-id
    Service <-- Redis: OK
  end
end

group proceed
  Client -> Controller: GET /api/rank?user_id=
  Client <-- Controller: rank of user
  Client -> Client: redirect /service.html
  Client -> ServiceController: GET /service.html
  Client <-- ServiceController
end

@enduml
```

```
Controller -> Service: generateToken(wait:queue, user-id)
Controller <-- Service: allow-token
Client <-- Controller: rank of user + Cookie(allow-token)
```
