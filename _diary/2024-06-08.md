#redis #system-design

### First-come, first-served

```plantuml
Client -> Controller: GET /waiting.html
Controller -> Service: enqueue(wait:queue, user-id)
Service -> Redis: ZADD NX wait:queue timestamp user-id
Service <-- Redis: OK
Controller <-- Service: rank of user (in wait:queue)
Client <-- Controller

group wait
Client -> Controller: GET /api/rank?user_id=
Controller -> Service: rank(wait:queue, user-id)
Controller <-- Service: rank of user
Client <-- Controller
end

group @Schedule
  Service -> Service: allow(wait:queue, count)
  Service -> Redis: ZPOPMIN wait:queue count
  Service <-- Redis: [user-id, ...]
  loop
 Service -> Redis: ZADD NX proceed:queue timestamp user-id[]
Service <-- Redis: OK
end
end

Client -> Controller: GET /api/rank?user_id=
Client <-- Controller: rank of user
Client -> AnotherController: GET /service.html
Client <-- AnotherController

Controller -> Service: generateToken(wait:queue, user-id)
Controller <-- Service: allow-token
Client <-- Controller: rank of user + Cookie(allow-token)
```
