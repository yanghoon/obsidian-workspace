#redis #system-design

### First-come, first-served

* [UserQueueService.java](https://github.com/morenice/fastcampus-2023-backend-advacned/blob/main/ch4/clip08/flow/src/main/java/com/fastcampus/flow/service/UserQueueService.java)

#### Sequence Diagram

##### V1

```plantuml
@startuml

participant Client
participant "Controller<Serivce>" as ServiceController
participant "Controller<Wait>" as Controller
participant Service
queue Redis

Client -> ServiceController: GET /service.html
  ServiceController -> ServiceController: retrieve allow_token (Cookie)
  ServiceController -> Controller: GET /api/allowed?user_id&allow_token
  ServiceController <-- Controller: not allowed
Client <-- ServiceController: 302 Found\nLocation: /waiting.html?user_id&redirect_url

Client -> Controller: GET /waiting.html?user_id&redirect_url
  Controller -> Service: enqueue(queue:wait, user_id)
    Service -> Redis: ZADD queue:wait timestamp user_id
    Service <-- Redis: OK
  Controller <-- Service: rank
Client <-- Controller: rank

group Waiting
  Client -> Controller: GET /api/rank?user_id
    Controller -> Service: rank(queue:wait, user_id)
    Controller <-- Service: rank
  Client <-- Controller: rank
end

group Schedule
  Service -> Service: allow(queue:wait, count)
  Service -> Redis: ZPOPMIN queue:wait count
  Service <-- Redis: [user_id, ...]
  loop
    Service -> Redis: ZADD queue:proceed timestamp user_id
    Service <-- Redis: OK
  end
end

group Proceed
  Client -> Controller: GET /api/rank?user_id
  Client <-- Controller: rank (-1)

  Client -> Controller: GET /api/token?user_id
    Controller -> Service: generateToken(queue:wait, user_id)
    Controller <-- Service: allow_token
  Client <-- Controller: rank of user + Cookie(allow-token)
end

Client -> Client: 302 Found\nLocation /service.html
Client -> ServiceController: GET /service.html
Client <-- ServiceController

@enduml
```

```
Controller -> Service: generateToken(wait:queue, user-id)
Controller <-- Service: allow-token
Client <-- Controller: rank of user + Cookie(allow-token)
```
